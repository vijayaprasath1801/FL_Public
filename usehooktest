import React from "react";
import { render, act, screen } from "@testing-library/react";
import { useAuth } from "react-oidc-context";
import { useDispatch } from "react-redux";
import { envActions } from "../reducers/env.reducer";
import { useAuthHook } from "./useAuthHook"; // Adjust the import path as necessary

// Mock the necessary dependencies
jest.mock("react-oidc-context", () => ({
  useAuth: jest.fn(),
}));

jest.mock("react-redux", () => ({
  useDispatch: jest.fn(),
}));

// Create a test component to use the hook
const TestComponent = () => {
  const { auth, env, panelopen, setPanelopen } = useAuthHook();
  return (
    <div>
      <button onClick={() => setPanelopen(!panelopen)}>Toggle Panel</button>
      {panelopen && <div data-testid="panel">Panel is open</div>}
      {auth.isAuthenticated && <div data-testid="authenticated">Authenticated</div>}
      {env && <div data-testid="env">{JSON.stringify(env)}</div>}
    </div>
  );
};

describe("useAuthHook", () => {
  const mockDispatch = jest.fn();
  const mockAuth = {
    isAuthenticated: false,
    user: {
      access_token: "mockAccessToken",
      profile: {
        sub: "mockUser Id",
        csgroups: ["role1", "role2"],
      },
    },
    events: {
      addAccessTokenExpiring: jest.fn(),
      addAccessTokenExpired: jest.fn(),
      remove:User  jest.fn(),
      revokeTokens: jest.fn(),
      signinRedirect: jest.fn(),
    },
  };

  beforeEach(() => {
    jest.clearAllMocks();
    (useDispatch as jest.Mock).mockReturnValue(mockDispatch);
    (useAuth as jest.Mock).mockReturnValue(mockAuth);
    sessionStorage.setItem("envConfig", JSON.stringify({ API_URL: "http://mockapi.com" }));
  });

  it("should update session storage and handle authentication", async () => {
    render(<TestComponent />);

    // Check if the environment variable is set
    expect(screen.getByTestId("env")).toBeInTheDocument();
    expect(screen.getByTestId("env").textContent).toBe(JSON.stringify({ API_URL: "http://mockapi.com" }));

    // Check initial state
    expect(screen.queryByTestId("authenticated")).toBeNull();

    // Simulate authentication
    mockAuth.isAuthenticated = true;
    render(<TestComponent />);

    // Check if authenticated state is rendered
    expect(screen.getByTestId("authenticated")).toBeInTheDocument();

    // Toggle the panel
    const toggleButton = screen.getByRole("button", { name: /Toggle Panel/i });
    act(() => {
      toggleButton.click();
    });

    // Check if the panel is open
    expect(screen.getByTestId("panel")).toBeInTheDocument();

    // Toggle the panel again
    act(() => {
      toggleButton.click();
    });

    // Check if the panel is closed
    expect(screen.queryByTestId("panel")).toBeNull();
  });
});
